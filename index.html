<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>School Term Countdown</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 40px;
      background: #f5f5f5;
    }
    #countdown {
      font-size: 2em;
      font-weight: bold;
      color: #2e7d32;
    }
    .note {
      margin-top: 20px;
      font-size: 0.9em;
      color: #555;
    }
  </style>
</head>
<body>
  <div id="countdown">Loading countdown...</div>
  <div class="note">Working days only — auto-updates to next Victorian school term end.</div>

  <script>
    // ======== CONFIGURATION ========
    const API_URL = "https://wovg-community.gateway.prod.api.vic.gov.au/vicgov/v2.0/important-dates";
    const API_KEY = ""; // Optional — only required if access is restricted

    // ======== HELPERS ========
    function getUrlParam(name, defaultValue) {
      const params = new URLSearchParams(window.location.search);
      return params.has(name) ? params.get(name) : defaultValue;
    }

    function parseValidDays(param) {
      return param.split(',')
        .map(s => parseInt(s.trim()))
        .filter(n => !isNaN(n) && n >= 0 && n <= 6);
    }

    function getWorkingDays(startDate, endDate, validDays) {
      let count = 0;
      const current = new Date(startDate);
      current.setHours(0, 0, 0, 0);
      while (current < endDate) {
        if (validDays.includes(current.getDay())) count++;
        current.setDate(current.getDate() + 1);
      }
      return count;
    }

    async function fetchTermEndDates() {
      const url = new URL(API_URL);
      url.searchParams.append("dateType", "SCHOOL_TERM");
      url.searchParams.append("sort", "important_date");

      const options = {
        method: "GET",
        headers: API_KEY ? { "apikey": API_KEY } : {}
      };

      const response = await fetch(url, options);
      if (!response.ok) throw new Error("Failed to fetch term dates");

      const json = await response.json();
      return json.records || [];
    }

    function findNextTermEnd(records) {
      const today = new Date();
      const futureEnds = records
        .filter(r => r.name.toLowerCase().includes("term") && r.name.toLowerCase().includes("end"))
        .map(r => ({
          date: new Date(r.important_date),
          name: r.name
        }))
        .filter(r => r.date > today)
        .sort((a, b) => a.date - b.date);

      return futureEnds.length > 0 ? futureEnds[0] : null;
    }

    async function updateCountdown() {
      const countdownEl = document.getElementById("countdown");
      try {
        const records = await fetchTermEndDates();
        const nextEnd = findNextTermEnd(records);

        if (!nextEnd) {
          countdownEl.textContent = "No upcoming term end date found.";
          return;
        }

        const daysParam = getUrlParam("days", "1,2,3,4,5");
        const validDays = parseValidDays(daysParam);

        const remaining = getWorkingDays(new Date(), nextEnd.date, validDays);

        if (remaining <= 0) {
          countdownEl.textContent = `Term has ended! (${nextEnd.name})`;
        } else {
          countdownEl.textContent = `${remaining} working day${remaining !== 1 ? "s" : ""} until ${nextEnd.name} (${nextEnd.date.toDateString()})`;
        }
      } catch (err) {
        console.error("Countdown error:", err);
        countdownEl.textContent = "Error fetching term dates.";
      }
    }

    updateCountdown();
  </script>
</body>
</html>
